<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>dPaul Technologies VU Meter</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
}

body {
  background: #131413;
  min-height: 100vh;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  font-family: 'Share Tech Mono', monospace;
  padding: 32px 20px 40px;
}

/* ── Brand ── */
.brand {
  font-size: 9px;
  letter-spacing: 4px;
  color: #2e2a26;
  text-transform: uppercase;
  text-align: center;
}

/* ── dB readout ── */
.db-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  flex: 1;
  justify-content: center;
}

.db-display {
  font-size: clamp(80px, 26vw, 130px);
  line-height: 1;
  color: #ff6010;
  letter-spacing: -4px;
  text-shadow:
    0 0 24px rgba(255,96,16,0.7),
    0 0 70px rgba(255,96,16,0.2);
  text-align: center;
  transition: color 0.08s, text-shadow 0.08s;
}

.db-display.peak {
  color: #ff1830;
  text-shadow:
    0 0 24px rgba(255,24,48,0.9),
    0 0 70px rgba(255,24,48,0.4);
}

.db-unit {
  font-size: 10px;
  letter-spacing: 6px;
  color: #3a2008;
  text-align: center;
}

/* ── Segment bar ── */
.bar-wrap {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.segments {
  display: flex;
  gap: 3px;
  height: 36px;
  width: 100%;
}

.seg {
  flex: 1;
  border-radius: 3px;
  background: #100804;
  transition: background 0.04s, box-shadow 0.04s;
}

.seg.lit-orange {
  background: #ff6010;
  box-shadow: 0 0 8px rgba(255,96,16,0.65);
}
.seg.lit-yellow {
  background: #ffaa00;
  box-shadow: 0 0 8px rgba(255,170,0,0.65);
}
.seg.lit-red {
  background: #ff1830;
  box-shadow: 0 0 10px rgba(255,24,48,0.75);
}

.bar-scale {
  display: flex;
  justify-content: space-between;
  font-size: 9px;
  color: #2a1a08;
  padding: 0 1px;
}

/* ── Buttons ── */
.btns {
  display: flex;
  gap: 10px;
  width: 100%;
}

button {
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  background: transparent;
  color: #4a2c10;
  border: 1px solid #221408;
  padding: 16px 0;
  border-radius: 4px;
  cursor: pointer;
  flex: 1;
  transition: all 0.12s;
  /* Larger touch target */
  min-height: 52px;
}

button:active,
button.active {
  color: #ff6010;
  border-color: #ff6010;
  background: rgba(255,96,16,0.1);
  box-shadow: 0 0 16px rgba(255,96,16,0.18);
}
</style>
</head>
<body>

<span class="brand">dPaul Technologies · VU Meter</span>

<div class="db-wrap">
  <div class="db-display" id="dbDisplay">—</div>
  <div class="db-unit">DECIBELS</div>
</div>

<div class="bar-wrap">
  <div class="segments" id="segments"></div>
  <div class="bar-scale">
    <span>-40</span>
    <span>-20</span>
    <span>0</span>
    <span>20</span>
    <span>50</span>
    <span>100</span>
  </div>
</div>

<div class="btns">
  <button id="btnMic">Mic</button>
  <button id="btnTest">Test</button>
  <button id="btnReset">Reset</button>
</div>

<script>
'use strict';

const MIN_DB = -40, MAX_DB = 100;
const NUM_SEGS = 36;

// Build segments
const segsEl = document.getElementById('segments');
for (let i = 0; i < NUM_SEGS; i++) {
  const d = document.createElement('div');
  d.className = 'seg';
  segsEl.appendChild(d);
}
const segs = Array.from(segsEl.children);

const idx0 = Math.round((80 - MIN_DB) / (MAX_DB - MIN_DB) * (NUM_SEGS - 1));
const idx2 = Math.round((90 - MIN_DB) / (MAX_DB - MIN_DB) * (NUM_SEGS - 1));

const dbDisplay = document.getElementById('dbDisplay');

function setLevel(db) {
  const filled = Math.round(((db - MIN_DB) / (MAX_DB - MIN_DB)) * (NUM_SEGS - 1));
  segs.forEach((s, i) => {
    if (i <= filled) {
      s.className = i >= idx2 ? 'seg lit-red' : i >= idx0 ? 'seg lit-yellow' : 'seg lit-orange';
    } else {
      s.className = 'seg';
    }
  });
  if (db <= MIN_DB) {
    dbDisplay.textContent = '—';
    dbDisplay.className = 'db-display';
  } else {
    dbDisplay.textContent = db.toFixed(1);
    dbDisplay.className = 'db-display' + (db >= 90 ? ' peak' : '');
  }
}

function resetMeter() {
  segs.forEach(s => s.className = 'seg');
  dbDisplay.textContent = '—';
  dbDisplay.className = 'db-display';
}

resetMeter();

// ── Simulation ────────────────────────────────────────────
let simInterval = null, simMode = null;

function stopSim() {
  clearInterval(simInterval); simInterval = null; simMode = null;
  document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
}

document.getElementById('btnTest').addEventListener('click', () => {
  if (simMode === 'test') { stopSim(); resetMeter(); return; }
  stopSim(); simMode = 'test';
  document.getElementById('btnTest').classList.add('active');
  let ph = 0;
  simInterval = setInterval(() => {
    ph++;
    let db = 30 + Math.sin(ph * 0.065) * 40 + Math.sin(ph * 0.028) * 20;
    db = Math.max(MIN_DB, Math.min(MAX_DB, db));
    setLevel(db);
  }, 55);
});

document.getElementById('btnReset').addEventListener('click', () => {
  stopSim(); resetMeter();
});

document.getElementById('btnMic').addEventListener('click', async () => {
  if (simMode === 'mic') { stopSim(); resetMeter(); return; }
  try {
    const stream   = await navigator.mediaDevices.getUserMedia({ audio: true });
    stopSim(); simMode = 'mic';
    document.getElementById('btnMic').classList.add('active');
    const actx     = new AudioContext();
    const src      = actx.createMediaStreamSource(stream);
    const analyser = actx.createAnalyser();
    analyser.fftSize = 512;
    src.connect(analyser);
    const buf = new Float32Array(analyser.fftSize);
    simInterval = setInterval(() => {
      analyser.getFloatTimeDomainData(buf);
      let sum = 0; buf.forEach(v => sum += v * v);
      const rms = Math.sqrt(sum / buf.length);
      const db  = rms > 0
        ? Math.max(MIN_DB, Math.min(MAX_DB, 20 * Math.log10(rms) + 90))
        : MIN_DB;
      setLevel(db);
    }, 55);
  } catch(e) { alert('Microphone access denied.'); }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dPaul Technologies VU Meter</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #131413;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: 'Share Tech Mono', monospace;
  gap: 32px;
}

.brand {
  font-size: 9px;
  letter-spacing: 5px;
  color: #2e2a26;
  text-transform: uppercase;
}

/* ── Main display panel ── */
.panel {
  width: 360px;
  background: #0a0804;
  border: 1px solid #221408;
  border-radius: 6px;
  padding: 28px 24px 24px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  box-shadow:
    inset 0 0 80px rgba(0,0,0,0.7),
    0 0 40px rgba(255,90,10,0.04);
  position: relative;
  overflow: hidden;
}

/* Scanlines */
.panel::after {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px,
    transparent 3px,
    rgba(0,0,0,0.2) 3px,
    rgba(0,0,0,0.2) 4px
  );
  pointer-events: none;
  z-index: 10;
}

/* ── Big dB readout ── */
.db-display {
  font-size: 80px;
  line-height: 1;
  color: #ff6010;
  letter-spacing: -3px;
  text-shadow:
    0 0 20px rgba(255,96,16,0.7),
    0 0 60px rgba(255,96,16,0.2);
  position: relative;
  z-index: 2;
  transition: color 0.1s, text-shadow 0.1s;
  min-width: 240px;
  text-align: center;
}
.db-display.peak {
  color: #ff1830;
  text-shadow: 0 0 20px rgba(255,24,48,0.9), 0 0 60px rgba(255,24,48,0.4);
}
.db-unit {
  font-size: 11px;
  letter-spacing: 4px;
  color: #4a2808;
  position: relative;
  z-index: 2;
  margin-top: -6px;
}

/* ── Segment bar ── */
.bar-wrap {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 4px;
  position: relative;
  z-index: 2;
}

.segments {
  display: flex;
  gap: 3px;
  height: 28px;
}

.seg {
  flex: 1;
  border-radius: 2px;
  background: #120a04;
  transition: background 0.05s, box-shadow 0.05s;
}

/* Colours when lit */
.seg.lit-orange {
  background: #ff6010;
  box-shadow: 0 0 6px rgba(255,96,16,0.7);
}
.seg.lit-yellow {
  background: #ffaa00;
  box-shadow: 0 0 6px rgba(255,170,0,0.7);
}
.seg.lit-red {
  background: #ff1830;
  box-shadow: 0 0 8px rgba(255,24,48,0.8);
}

/* Scale labels under bar */
.bar-scale {
  display: flex;
  justify-content: space-between;
  padding: 0 1px;
  font-size: 8px;
  color: #2a1a08;
  letter-spacing: 0;
}

/* ── Buttons ── */
.btns {
  display: flex;
  gap: 10px;
}

button {
  font-family: 'Share Tech Mono', monospace;
  font-size: 9px;
  letter-spacing: 3px;
  text-transform: uppercase;
  background: transparent;
  color: #4a2c10;
  border: 1px solid #221408;
  padding: 10px 20px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.12s;
}
button:hover {
  color: #ff6010;
  border-color: #ff6010;
  background: rgba(255,96,16,0.05);
  box-shadow: 0 0 12px rgba(255,96,16,0.12);
}
button.active {
  color: #ff6010;
  border-color: #ff6010;
  background: rgba(255,96,16,0.1);
  box-shadow: 0 0 16px rgba(255,96,16,0.2);
}
</style>
</head>
<body>

<span class="brand">dPaul Technologies · VU Meter</span>

<div class="panel">
  <div class="db-display" id="dbDisplay">—</div>
  <div class="db-unit">DECIBELS</div>

  <div class="bar-wrap">
    <div class="segments" id="segments"></div>
    <div class="bar-scale">
      <span>-40</span>
      <span>-30</span>
      <span>-20</span>
      <span>-10</span>
      <span>-5</span>
      <span>0</span>
      <span>+3</span>
    </div>
  </div>
</div>

<div class="btns">
  <button id="btnMic">Mic Input</button>
  <button id="btnTest">Test</button>
  <button id="btnReset">Reset</button>
</div>

<script>
'use strict';

const MIN_DB = -40, MAX_DB = 3;
const NUM_SEGS = 40;

// Build segments
const segsEl = document.getElementById('segments');
for (let i = 0; i < NUM_SEGS; i++) {
  const d = document.createElement('div');
  d.className = 'seg';
  segsEl.appendChild(d);
}
const segs = Array.from(segsEl.children);

// Which segment index corresponds to 0dB and +2dB
const idx0  = Math.round((0  - MIN_DB) / (MAX_DB - MIN_DB) * (NUM_SEGS - 1));
const idx2  = Math.round((2  - MIN_DB) / (MAX_DB - MIN_DB) * (NUM_SEGS - 1));

const dbDisplay = document.getElementById('dbDisplay');

function setLevel(db) {
  const filled = Math.round(((db - MIN_DB) / (MAX_DB - MIN_DB)) * (NUM_SEGS - 1));

  segs.forEach((s, i) => {
    if (i <= filled) {
      if (i >= idx2)      s.className = 'seg lit-red';
      else if (i >= idx0) s.className = 'seg lit-yellow';
      else                s.className = 'seg lit-orange';
    } else {
      s.className = 'seg';
    }
  });

  // dB number
  if (db <= MIN_DB) {
    dbDisplay.textContent = '—';
    dbDisplay.className = 'db-display';
  } else {
    dbDisplay.textContent = (db >= 0 ? '+' : '') + db.toFixed(1);
    dbDisplay.className = 'db-display' + (db >= 0 ? ' peak' : '');
  }
}

function resetMeter() {
  segs.forEach(s => s.className = 'seg');
  dbDisplay.textContent = '—';
  dbDisplay.className = 'db-display';
}

resetMeter();

// ── Simulation ────────────────────────────────────────────
let simInterval = null, simMode = null;

function stopSim() {
  clearInterval(simInterval); simInterval = null; simMode = null;
  document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
}

document.getElementById('btnTest').addEventListener('click', () => {
  if (simMode === 'test') { stopSim(); resetMeter(); return; }
  stopSim(); simMode = 'test';
  document.getElementById('btnTest').classList.add('active');
  let ph = 0;
  simInterval = setInterval(() => {
    ph++;
    let db = -8 + Math.sin(ph * 0.065) * 14 + Math.sin(ph * 0.028) * 6;
    db = Math.max(MIN_DB, Math.min(MAX_DB, db));
    setLevel(db);
  }, 55);
});

document.getElementById('btnReset').addEventListener('click', () => {
  stopSim(); resetMeter();
});

document.getElementById('btnMic').addEventListener('click', async () => {
  if (simMode === 'mic') { stopSim(); resetMeter(); return; }
  try {
    const stream   = await navigator.mediaDevices.getUserMedia({ audio: true });
    stopSim(); simMode = 'mic';
    document.getElementById('btnMic').classList.add('active');
    const actx     = new AudioContext();
    const src      = actx.createMediaStreamSource(stream);
    const analyser = actx.createAnalyser();
    analyser.fftSize = 512;
    src.connect(analyser);
    const buf = new Float32Array(analyser.fftSize);
    simInterval = setInterval(() => {
      analyser.getFloatTimeDomainData(buf);
      let sum = 0; buf.forEach(v => sum += v * v);
      const rms = Math.sqrt(sum / buf.length);
      const db  = rms > 0
        ? Math.max(MIN_DB, Math.min(MAX_DB, 20 * Math.log10(rms) + 28))
        : MIN_DB;
      setLevel(db);
    }, 55);
  } catch(e) { alert('Microphone access denied.'); }
});
</script>
</body>
</html>
